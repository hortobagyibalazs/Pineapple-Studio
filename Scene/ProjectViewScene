function ProjectViewScene(program)
  local self = Scene("project", program, "ProjectViewScene")
  
  local fileViewers = {}
  local toolbars = {}
  local menuBarItems = {}
  
  local currentFileViewer = nil
  local lastSaveTime = nil
  
  function self.onStart()
    local function resizeChildren(parent) 
      for k, v in pairs(parent.Children) do
        local name = v.Name or "-"
        
        if v.RelativeX ~= nil then
          v.X = program:ParseStringSize(parent, "X", v.RelativeX)
        end
        if v.RelativeWidth ~= nil then
          v.Width = program:ParseStringSize(parent, "Width", v.RelativeWidth)
        end
        if v.RelativeY ~= nil then
          v.Y = program:ParseStringSize(parent, "Y", v.RelativeY)
        end
        if v.RelativeHeight ~= nil then
          v.Height = program:ParseStringSize(parent, "Height", v.RelativeHeight)
        end
                
        if type(v.Children) == "table" and #v.Children > 0 then
          resizeChildren(v)
        end
      end
    end
    
    local defaultFileViewAttributes = {
      self.view:GetObject("FileView").X,
      self.view:GetObject("FileView").Y,
      self.view:GetObject("FileView").Width,
      self.view:GetObject("FileView").Height
    }
    
    self.view:GetObject("FileView").OnUpdate = function(_self)
      local width = _self.Width
      
      if self.view:GetObject("LeftToolBar").Visible then
        _self.X = defaultFileViewAttributes[1] + self.view:GetObject("LeftToolBar").X + self.view:GetObject("LeftToolBar").Width - 1
        width = program.View.Width - _self.X + 1
      end
      
      if self.view:GetObject("RightToolBar").Visible then
        width = width - self.view:GetObject("RightToolBar").Width
      end
      
      _self.Width = width
      
      if self.view:GetObject("BottomToolBar").Visible then
        _self.Height = self.view:GetObject("BottomToolBar").Y - _self.Y
      end
      
      resizeChildren(_self)
    end
    
    local draggingLeftToolBar = false
    local draggingRightToolBar = false
    local draggingBottomToolBar = false
    
    self.view:GetObject("LeftToolBarResizeDraggable").InterceptingDragEvents = function(self)
      return draggingLeftToolBar
    end
    
    self.view:GetObject("LeftToolBarResizeDraggable").OnClick = function(_self)
      draggingLeftToolBar = true
      draggingRightToolBar = false
      draggingBottomToolBar = false
      
      _self.Text = ":"
      self.view:GetObject("RightToolBarResizeDraggable").Text = "="
      self.view:GetObject("BottomToolBarResizeDraggable").Text = "="
      
      self.view:GetObject("LeftToolBar").Z = math.max(self.view:GetObject("RightToolBar").Z,
      self.view:GetObject("BottomToolBar").Z) + 1
    end
    
    self.view:GetObject("RightToolBarResizeDraggable").InterceptingDragEvents = function(self)
      return draggingRightToolBar
    end
    
    self.view:GetObject("RightToolBarResizeDraggable").OnClick = function(_self)
      draggingRightToolBar = true
      draggingLeftToolBar = false
      draggingBottomToolBar = false
      
      _self.Text = ":"
      self.view:GetObject("LeftToolBarResizeDraggable").Text = "="
      self.view:GetObject("BottomToolBarResizeDraggable").Text = "="
      
      self.view:GetObject("RightToolBar").Z = math.max(self.view:GetObject("LeftToolBar").Z,
      self.view:GetObject("BottomToolBar").Z) + 1
    end
    
    self.view:GetObject("BottomToolBarResizeDraggable").InterceptingDragEvents = function(self)
      return draggingBottomToolBar
    end
    
    self.view:GetObject("BottomToolBarResizeDraggable").OnClick = function(_self)
      draggingBottomToolBar = true
      draggingLeftToolBar = false
      draggingRightToolBar = false
      
      _self.Text = ":"
      self.view:GetObject("LeftToolBarResizeDraggable").Text = "="
      self.view:GetObject("RightToolBarResizeDraggable").Text = "="
      
      self.view:GetObject("BottomToolBar").Z = math.max(self.view:GetObject("RightToolBar").Z,
      self.view:GetObject("LeftToolBar").Z) + 1
    end
    
    program.View.DoClick = function(_self, object, event, side, x, y)
      local interceptingDragEvents = false
    
      local function checkIfChildInterceptsDragEvents(view)
        if type(view.Children) ~= "table" then return end
        for k, v in pairs(view.Children) do
          if v.InterceptingDragEvents ~= nil and v:InterceptingDragEvents() then
            interceptingDragEvents = true
          end
          checkIfChildInterceptsDragEvents(v)
        end
      end
      
      checkIfChildInterceptsDragEvents(_self)
    
      if object and (not interceptingDragEvents) then
        if _self:CheckClick(object, x, y) then
          local offset = {X = 0, Y = 0}
          if not object.Fixed and _self.ChildOffset then
            offset = _self.ChildOffset
          end
          return object:Click(event, side, x - object.X - offset.X + 1, y - object.Y + 1 - offset.Y)
        end
      end
    end	
    
    program.View.OnDrag = function(_, event, button, x, y)
      if draggingLeftToolBar then
        if (x >= self.view:GetObject("RightToolBar").X) then 
          x = self.view:GetObject("RightToolBar").X - 1
        end
          
        self.view:GetObject("LeftToolBar").Width = x
        resizeChildren(self.view:GetObject("LeftToolBar"))
        
        self.view:GetObject("FileView"):OnUpdate()
        
        return true
      end
      
      if draggingRightToolBar then
        if (x <= self.view:GetObject("LeftToolBar").X + self.view:GetObject("LeftToolBar").Width - 1) then
          x = self.view:GetObject("LeftToolBar").X + self.view:GetObject("LeftToolBar").Width
        end
          
        self.view:GetObject("RightToolBar").X = x
        self.view:GetObject("RightToolBar").Width = self.view.Width - self.view:GetObject("RightToolBar").X + 1
        resizeChildren(self.view:GetObject("RightToolBar"))
        
        self.view:GetObject("FileView"):OnUpdate()
        
        return true
      end
      
      if draggingBottomToolBar then
        if (y <= self.view:GetObject("MenuBar").X + self.view:GetObject("MenuBar").Height - 1) then
          y = self.view:GetObject("MenuBar").X + self.view:GetObject("MenuBar").Height
        end
        
        self.view:GetObject("BottomToolBar").Y = y
        self.view:GetObject("BottomToolBar").Height = self.view.Height - self.view:GetObject("BottomToolBar").Y + 1
        resizeChildren(self.view:GetObject("BottomToolBar"))
        
        self.view:GetObject("FileView"):OnUpdate()
        
        return true
      end
    end
    
    program.View.OnMouseRelease = function()
      draggingLeftToolBar = false
      draggingRightToolBar = false
      draggingBottomToolBar = false
      
      self.view:GetObject("LeftToolBarResizeDraggable").Text = "="
      self.view:GetObject("RightToolBarResizeDraggable").Text = "="
      self.view:GetObject("BottomToolBarResizeDraggable").Text = "="
    end
    
    resizeChildren(self.view)
  end
  
  self.loadComponents({
  
    ["ProjectManager"] = {
      ["obtain"] = function()
        return program.projectManager
      end
    },
    
    
    ["MenuBar"] = {
      ["addMenu"] = function(extension, label)      
        local xCoords = {}
        for k, v in pairs(self.view:GetObject("MenuBar").Children) do
          table.insert(xCoords, {v.X, v.Width})
          if v.Name == label.."Menu" then
            return
          end
        end
        table.sort(xCoords, function(e1, e2) return e1[1] < e2[1] end)
        local lastMenu = xCoords[#xCoords]
        if lastMenu == nil or #lastMenu == 0 then
          lastMenu = {[1] = 1, [2] = 0}
        end
        
        Logger.log("ProjectViewScene: Add menu '"..label.."' to MenuBar")
        self.view:GetObject("MenuBar"):AddObject({
          ["Type"] = "Button",
          ["Name"] = label.."Menu",
          ["Text"] = label,
          ["X"] = lastMenu[1] + lastMenu[2],
          ["Y"] = 1,
          ["Height"] = 1,
          ["Width"] = #label + 2,
          ["AddedBy"] = extension.getId(),
          ["OnClick"] = function(_self, event, side, x, y)
            local children = {}
            if type(menuBarItems[label]) == "table" then
              for k, v in pairs(menuBarItems[label]) do
                table.insert(children, {
                  Type = "Button",
                  Text = k,
                  OnClick = menuBarItems[label][k]
                })
              end
              _self:ToggleMenu({
                ["Type"] = "Menu",
                ["Children"] = children
              }, x, y)
            end
          end
        })
      end,
      ["removeMenu"] = function(extension, label)
        for k, v in pairs(self.view:GetObject("MenuBar")) do
          -- id checking is needed to ensure that a menu only gets removed by the extension that created it
          if v.Name == label and v.AddedBy == extension.getId() then
            self.view:GetObject():RemoveObject(v.Name)
          end
        end
      end,
      ["addMenuItem"] = function(extension, menu, item, onClick)
        if menuBarItems[menu] == nil then
          menuBarItems[menu] = {}
        end
        
        menuBarItems[menu][item] = onClick
      end
    },
    
    ["FileViewer"] = {
      -- called when a file open event is fired
      -- canOpenFile : a 'function' typed parameter which receives a file path and returns a boolean
      -- getViewOnFileOpen: a 'function' typed parameter which returns a Bedrock view
      ["addViewer"] = function(viewer)
        table.insert(fileViewers, viewer)
        return viewer
      end,
      ["getViewer"] = function(name)
        return currentFileViewer
      end,
      ["getOpenFileViewer"] = function()
        return currentFileViewer
      end,
      ["openFile"] = function(path, viewer)
        if viewer ~= currentFileViewer and (currentFileViewer ~= nil and currentFileViewer.getOpenFilePath() == path) then
          return
        end
      
        local preferredViewer = nil
        if viewer ~= nil and viewer.getFileCompatibilityLevel(path) > 0 then
          preferredViewer = viewer
        else
          for k, v in pairs(fileViewers) do
            if preferredViewer == nil and v.getFileCompatibilityLevel(path) > 0 then
              preferredViewer = v
            end
            
            if preferredViewer and preferredViewer.getFileCompatibilityLevel(path) < v.getFileCompatibilityLevel(path) then
              preferredViewer = v
            end
          end
        end
        
        if preferredViewer then
          self.getComponent("FileViewer").saveOpenFile()
          
          currentFileViewer = preferredViewer
          currentFileViewer.getOpenFilePath = function() return path end
          
          self.view:GetObject("FileView"):RemoveAllObjects()
          self.view:GetObject("FileView"):AddObject(currentFileViewer.getView())
          self.view:GetObject("FileView"):OnUpdate()
        end
      end,
      ["saveOpenFile"] = function()
        if currentFileViewer ~= nil then
          local fileContent = currentFileViewer.getOpenFileContent()
          local path = currentFileViewer.getOpenFilePath()
      
          if path then
            local f = fs.open(path, "w")
            if f then
              lastSaveTime = os.clock()
            
              Logger.log("ProjectViewScene: Saving open file")
              f.write(fileContent)
              f.close()
            end
          end  
        end
      end,
      ["getLastSaveTime"] = function()
        return lastSaveTime
      end,
      ["getObject"] = function(name)
        return self.view:GetObject("FileView"):GetObject(name)
      end
    },
    
    
    -- left, right, bottom tool bar
    ["ToolBar"] = {
      ["add"] = function(label, view)
        toolbars[label] = view
        
        self.view:GetObject("LeftToolBarContentView"):AddObject(view)
      end
    },
    
    
    ["Timer"] = {
      ["startRepeatingTimer"] = function(func, interval)
        return program:StartRepeatingTimer(func, interval)
      end,
      ["stop"] = function(timer)
        program:StopTimer(timer)
      end
    }
    
  })
  
  return self
end