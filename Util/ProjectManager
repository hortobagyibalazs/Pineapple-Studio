PROJECT_FILE_EXT = "psp" -- Pineapple Studio Project

function ProjectManager(programInst)
  local self = {}
  
  local program = programInst
  local openProject = nil
  local listeners = {}
  
  function self.open(project)
    Logger.log("ProjectManager: Opening "..project.getProjectDir())
    if not project.exists() then
      Logger.log("ProjectManager: Creating project directory and updating config file")
      if not project.singleFile() then
        fs.makeDir(project.getProjectDir())
      else
        local f = fs.open(project.getProjectDir(), "w")
        f.write()
        f.flush()
        f.close()
      end
    end
    
    -- Find project file
    if not project.singleFile() then
      local rootFiles = fs.list(project.getProjectDir())
      local projectFileExists = false
      for k, v in pairs(rootFiles) do
        if #v > 4 and v:sub(#v-#PROJECT_FILE_EXT) == "."..PROJECT_FILE_EXT then
          Logger.log("ProjectManager: Project file found")
          projectFileExists = true
        end
      end
    
      if not projectFileExists then
        local projectFilePath = project.getProjectDir().."/"..RandomKey()..".psp"
        local file = fs.open(projectFilePath, "w")
        if file then
          file.write(project.getName())
          file.flush()
          file.close()
          Logger.log("ProjectManager: Project file created")
        else
          Logger.log("ProjectManager: Couldn't create project file")
        end
      end
    end
    
    if openProject ~= project then
      self.close()
      
      openProject = project
      if not openProject.singleFile() then
        openProject.refreshProjectTree()
      end
      
      for k, v in pairs(listeners) do
        v(openProject)
      end
      Logger.log("ProjectManager: Opened project")
    else
      Logger.log("ProjectManager: Skipped re-opening")
    end
  end
  
  function self.close()
    self.openProject = nil
    for k, v in pairs(listeners) do
      v(self.openProject)
    end
  end
  
  function self.delete()
    --TODO : Implement
  end
  
  function self.exists()
    return fs.exists(self.getProjectDir())
  end  
  
  function self.getProject()
    return openProject
  end
  
  function self.addProjectChangeListener(listener)
    table.insert(listeners, listener)
  end
  
  function self.removeProjectChangeListener(listener)
    table.remove(listeners, listener)
  end
  
  function self.removeProjectChangeListeners()
    listeners = {}
  end
  
  return self
end