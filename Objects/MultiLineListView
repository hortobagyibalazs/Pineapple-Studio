Inherit = "ListView"
ItemMargin = 1

local function AddItem(self, v, x, y, group)
	local toggle = false
	if not self.CanSelect then
		toggle = nil
	elseif v.Selected then
		toggle = true
	end
  
	local item = {
		["Width"]=self.Width,
		["X"]=x,
		["Y"]=y,
		["Name"]="ListViewItem",
		["Type"]="MultiLineButton",
		["TextColour"]=self.TextColour,
		["BackgroundColour"]=0,
		["ActiveTextColour"]=self.SelectionTextColour,
		["ActiveBackgroundColour"]=self.SelectionBackgroundColour,
		["Align"]='Left',
		["Toggle"]=toggle,
		["Group"]=group,
		OnClick = function(itm)
			if self.CanSelect then
				self:SelectItem(itm)
			elseif self.OnSelect then
				self:OnSelect(itm.Text)
			end
		end
    }
    if type(v) == 'table' then
    	for k, _v in pairs(v) do
    		item[k] = _v
    	end
    else
      item.Text = v
      item.Height = math.ceil(#item.Text/self.Width)
    end
    
    for k, v in pairs(self.Items) do
      if v == item.Text and k % 2 == 0 then
        item.TextColour = colors.lightGray
      end
    end
	
	local itm = self:AddObject(item)
	if v.Selected then
		self:SelectItem(itm)
	end
end

UpdateItems = function(self)
	if not self.Items or type(self.Items) ~= 'table' then
		self.Items = {}
	end
	self.Selected = nil
	self:RemoveAllObjects()
	local groupMode = false
	for k, v in pairs(self.Items) do
		if type(k) == 'string' then
			groupMode = true
			break
		end
	end

	if not groupMode then
    local lastY = 1
    local lastHeight = 0
		for i, v in ipairs(self.Items) do
      local y = lastY + lastHeight
    
			AddItem(self, v, self.ItemMargin, y)
      
      local text = v
      if type(v) == "table" then
        text = v.Text
      end
      
      lastHeight = math.ceil(#v/self.Width)
      lastY = y
    end
	else
		local y = self.TopMargin
		for k, v in pairs(self.Items) do
			y = y + 1
			AddItem(self, {Text = k, TextColour = self.HeadingColour, IgnoreClick = true}, self.HeadingMargin, 1)
			for i, _v in ipairs(v) do
				y = y + 1
				AddItem(self, _v, 1, y, k)
			end
			y = y + 1
		end
	end
	self:UpdateScroll()
	self.NeedsItemUpdate = false
end